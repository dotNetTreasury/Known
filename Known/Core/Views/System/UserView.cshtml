<template>
    <div class="layui-fit">
        <div class="fit-col">
            <table id="gridUser" class="layui-hide" lay-filter="gridUser"></table>
        </div>
    </div>
    <script type="text/html" id="tbUser">
        <div class="layui-btn-container">
            <button class="layui-btn layui-btn-sm" lay-event="add">
                <i class="layui-icon layui-icon-addition"></i>新增
            </button>
            <button class="layui-btn layui-btn-sm" lay-event="edit">
                <i class="layui-icon layui-icon-edit"></i>编辑
            </button>
            <button class="layui-btn layui-btn-sm" lay-event="remove">
                <i class="layui-icon layui-icon-delete"></i>删除
            </button>
            <button class="layui-btn layui-btn-sm" lay-event="imports">
                <i class="layui-icon layui-icon-add-1"></i>导入
            </button>
        </div>
    </script>
    <script type="text/html" id="dialogUser">
        <table class="layui-form form" lay-filter="formUser">
            <tr>
                <th style="width:80px;">用户名</th>
                <td>
                    <input type="hidden" name="Id">
                    <input type="text" name="UserName" lay-verify="required" placeholder="" readonly autocomplete="off" class="layui-input">
                </td>
                <th style="width:80px;">姓名</th>
                <td>
                    <input type="text" name="Name" lay-verify="required" placeholder="" autocomplete="off" class="layui-input">
                </td>
                <th style="width:80px;">英文名</th>
                <td>
                    <input type="text" name="EnglishName" placeholder="" autocomplete="off" class="layui-input">
                </td>
            </tr>
            <tr>
                <th>座机</th>
                <td>
                    <input type="text" name="Phone" lay-verify="phone" placeholder="" autocomplete="off" class="layui-input">
                </td>
                <th>手机</th>
                <td>
                    <input type="text" name="Mobile" lay-verify="phone" placeholder="" autocomplete="off" class="layui-input">
                </td>
                <th>邮箱</th>
                <td>
                    <input type="text" name="Email" lay-verify="email" placeholder="" autocomplete="off" class="layui-input">
                </td>
            </tr>
            <tr>
                <th>性别</th>
                <td>
                    <input type="radio" name="Gender" value="男" title="男">
                    <input type="radio" name="Gender" value="女" title="女" checked>
                </td>
                <th>选项</th>
                <td colspan="3">
                    <input type="checkbox" name="Enabled" lay-skin="switch" lay-text="启用|禁用" value="1">
                </td>
            </tr>
            <tr>
                <th>备注</th>
                <td colspan="5">
                    <textarea name="Note" placeholder="" class="layui-textarea"></textarea>
                </td>
            </tr>
        </table>
    </script>
</template>

<script>
    layui.define('helper', function (exports) {
        var url = {
            QueryUsers: '~/System/QueryUsers',
            DeleteUsers: '~/System/DeleteUsers',
            ImportUsers: '~/System/ImportUsers',
            GetUser: '~/System/GetUser',
            SaveUser: '~/System/SaveUser',
            SaveUserRole: '~/System/SaveUserRole'
        };

        var $ = layui.jquery,
            layer = layui.layer,
            helper = layui.helper;

        var form = helper.form({
            name: 'formUser',
            defData: { Id: '', Enabled: 1 },
            config: {
                area: ['750px', '290px'],
                content: $('#dialogUser').html(),
                init: function (e) {
                    var userName = e.form.getField('UserName');
                    userName.attr('readonly', 'readonly');
                    if (e.data.Id === '') {
                        userName.removeAttr('readonly');
                    }
                }
            },
            toolbar: [{
                text: '保存', handler: function (e) {
                    var data = e.form.getData();
                    $.post(url.SaveUser, {
                        data: JSON.stringify(data)
                    }, function (result) {
                        layer.msg(result.message);
                        if (result.ok) {
                            data.Id = result.data;
                            e.form.setData(data);
                            e.form.close();
                            grid.reload();
                        }
                    });
                }
            }]
        });

        var grid = helper.grid({
            name: 'gridUser',
            config: {
                url: url.QueryUsers, toolbar: '#tbUser', height: 'full-25',
                cols: [[
                    { type: 'numbers', fixed: 'left' },
                    { type: 'checkbox', fixed: 'left' },
                    { sort: true, title: '用户名', field: 'UserName', width: 100 },
                    { sort: true, title: '姓名', field: 'Name', width: 100 },
                    { sort: true, title: '英文名', field: 'EnglishName', width: 100 },
                    { sort: true, title: '性别', field: 'Gender', width: 80, align: 'center' },
                    { sort: true, title: '座机', field: 'Phone', width: 120 },
                    { sort: true, title: '手机', field: 'Mobile', width: 120, align: 'center' },
                    { sort: true, title: '邮箱', field: 'Email', width: 150 },
                    {
                        sort: true, title: '状态', field: 'Enabled', width: 100, templet: function (d) {
                            var checked = d.Enabled ? ' checked' : '';
                            return '<input type="checkbox" lay-skin="switch" lay-text="启用|禁用" disabled' + checked + '>';
                        }
                    },
                    { sort: true, title: '首次登录时间', field: 'FirstLoginTime', width: 150, align: 'center' },
                    { sort: true, title: '首次登录IP', field: 'FirstLoginIP', width: 100, align: 'center' },
                    { sort: true, title: '上次登录时间', field: 'LastLoginTime', width: 150, align: 'center' },
                    { sort: true, title: '上次登录IP', field: 'LastLoginIP', width: 100, align: 'center' }
                ]]
            },
            toolbar: {
                add: function (e) { form.show(); },
                edit: function (e) { e.editRow(form); },
                remove: function (e) { e.deleteRows(url.DeleteUsers); },
                imports: function (e) { }
            }
        });

        exports('System_UserView', {});
    });
</script>